<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToonSphere</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg-primary: #000000;        /* –ß–µ—Ä–Ω—ã–π —Ñ–æ–Ω */
            --bg-secondary: #0d1117;      /* –¢–µ–º–Ω–æ-—Å–∏–Ω–∏–π —Ñ–æ–Ω */
            --bg-tertiary: #161b22;       /* –°—Ä–µ–¥–Ω–µ-—Å–∏–Ω–∏–π —Ñ–æ–Ω */
            --accent: #58a6ff;            /* –°–∏–Ω–∏–π –∞–∫—Ü–µ–Ω—Ç */
            --accent-hover: #388bfd;      /* –¢–µ–º–Ω–æ-—Å–∏–Ω–∏–π hover */
            --text-primary: #ffffff;      /* –ë–µ–ª—ã–π —Ç–µ–∫—Å—Ç */
            --text-secondary: #c9d1d9;     /* –°–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π —Ç–µ–∫—Å—Ç */
            --text-muted: #8b949e;        /* –°–µ—Ä—ã–π —Ç–µ–∫—Å—Ç */
            --border: #30363d;            /* –°–∏–Ω–∏–π-—á–µ—Ä–Ω—ã–π –±–æ—Ä–¥–µ—Ä */
            --shadow: rgba(88, 166, 255, 0.15); /* –°–∏–Ω—è—è —Ç–µ–Ω—å */
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        /* –°–∫—Ä—ã—Ç–∏–µ –ø–æ–ª–æ—Å—ã –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
        ::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }
        
        * {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        /* Header */
        .header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 24px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
            text-decoration: none;
        }
        
        .nav {
            display: flex;
            gap: 32px;
        }
        
        .nav-item {
            padding: 8px 16px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
            font-size: 0.95rem;
            font-weight: 500;
        }
        
        .nav-item:hover {
            color: var(--text-primary);
            background: var(--bg-secondary);
        }
        
        .nav-item.active {
            color: var(--accent);
            background: rgba(88, 166, 255, 0.1);
        }
        
        /* Layout */
        .main {
            max-width: 1600px;
            margin: 0 auto;
            padding: 32px 24px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 32px;
        }
        
        .layout-2col {
            grid-template-columns: 3fr 2fr;
        }
        
        /* Player Panel */
        .player-panel {
            background: var(--bg-secondary);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid var(--border);
        }
        
        .player-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .player-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .player-status {
            font-size: 0.85rem;
            color: var(--text-muted);
            padding: 4px 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
        }
        
        .video-container {
            position: relative;
            background: #000;
        }
        
        video {
            width: 100%;
            height: auto;
            max-height: 60vh;
            display: block;
        }
        
        .player-controls {
            padding: 16px 24px;
            background: var(--bg-tertiary);
        }
        
        .buffer-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        
        .buffer-bar {
            flex: 1;
            height: 4px;
            background: var(--bg-secondary);
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }
        
        .buffer-progress {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #1f6feb);
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        .stream-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
            margin-top: 8px;
            font-size: 0.75rem;
        }
        
        .stat-item {
            background: var(--bg-secondary);
            padding: 6px 8px;
            border-radius: 4px;
            text-align: center;
        }
        
        .stat-value {
            color: var(--accent);
            font-weight: 600;
        }
        
        .quality-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .quality-btn {
            padding: 6px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }
        
        .quality-btn:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }
        
        .quality-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #ffffff;
        }
        
        /* Content Panel */
        .content-panel {
            background: var(--bg-secondary);
            border-radius: 16px;
            border: 1px solid var(--border);
            overflow: hidden;
            width: 100%;
            box-sizing: border-box;
            padding: 24px;
        }

        
        .panel-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .panel-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .panel-action {
            padding: 6px 12px;
            background: var(--accent);
            color: #ffffff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .panel-action:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }
        
        .panel-content {
            padding: 0;
            max-height: 70vh;
            overflow-y: auto;
            width: 100%;
            box-sizing: border-box;
        }
        
        /* Cards */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .card {
            background: var(--bg-tertiary);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            position: relative;
        }
        
        .card:hover {
            transform: translateY(-2px);
            border-color: var(--accent);
            box-shadow: 0 8px 32px var(--shadow);
        }
        
        .card-image {
            width: 100%;
            height: 470px;
            padding: 10px;
            background: linear-gradient(135deg, var(--bg-tertiary), var(--border));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: var(--text-muted);
        }
        
        .card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .card-content {
            padding: 16px;
        }
        
        .card-title {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-primary);
            line-height: 1.3;
        }
        
        .card-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 8px;
        }
        
        .card-description {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .card-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: rgba(255, 59, 48, 0.9);
            border: none;
            border-radius: 50%;
            color: #fff;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.2s ease;
        }
        
        .card:hover .card-delete {
            opacity: 1;
        }
        
        .card-delete:hover {
            background: #ff3b30;
            transform: scale(1.1);
        }
        
        /* Episodes List */
        .episodes-section {
            margin-bottom: 24px;
        }
        
        .season-header {
            font-size: 1rem;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }
        
        .episodes-grid {
            display: grid;
            gap: 8px;
        }
        
        .episode-item {
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .episode-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent);
        }
        
        .episode-info {
            flex: 1;
        }
        
        .episode-title {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 2px;
        }
        
        .episode-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        /* Forms */
        .form-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 24px;
        }
        
        .form-container {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }
        
        .form-header {
            margin-bottom: 24px;
        }
        
        .form-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        .form-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: border-color 0.2s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 32px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background: var(--accent);
            color: #ffffff;
        }
        
        .btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--border);
        }
        
        /* Utilities */
        .hidden { display: none !important; }
        
        .back-btn {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 24px;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }
        
        .back-btn:hover {
            background: var(--border);
            color: var(--text-primary);
        }
        
        /* Responsive */
        @media (max-width: 1400px) {
            .layout-2col {
                grid-template-columns: 2fr 2fr;
            }
        }
        
        @media (max-width: 1024px) {
            .layout-2col {
                grid-template-columns: 1fr;
            }
            
            .main {
                max-width: 100%;
                padding: 16px;
                gap: 16px;
            }
        }
        
        @media (max-width: 768px) {
            .header {
                position: relative;
            }
            
            .header-content {
                padding: 0 16px;
                height: auto;
                min-height: 60px;
                flex-direction: column;
                gap: 12px;
            }
            
            .logo {
                font-size: 1.3rem;
            }
            
            .nav {
                gap: 8px;
                width: 100%;
                justify-content: center;
            }
            
            .nav-item {
                padding: 10px 16px;
                font-size: 0.9rem;
                flex: 1;
                text-align: center;
                border-radius: 12px;
            }
            
            .main {
                padding: 16px 12px;
                gap: 16px;
            }
            
            .player-panel {
                order: 1;
                border-radius: 12px;
            }
            
            .content-panel {
                order: 2;
                padding: 16px;
                border-radius: 12px;
            }
            
            .panel-header {
                padding: 16px 0;
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }
            
            .panel-action {
                width: 100%;
                padding: 14px;
                font-size: 1rem;
                border-radius: 12px;
            }
            
            .cards-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .card {
                border-radius: 16px;
            }
            
            .card-image {
                height: 180px;
                border-radius: 12px;
                margin: 8px;
                width: calc(100% - 16px);
            }
            
            .card-content {
                padding: 16px;
            }
            
            video {
                max-height: 50vh;
                border-radius: 8px;
            }
            
            .player-controls {
                padding: 16px;
            }
            
            .quality-selector {
                justify-content: center;
                gap: 12px;
            }
            
            .quality-btn {
                padding: 10px 16px;
                border-radius: 8px;
                font-size: 0.9rem;
            }
            
            .stream-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .form-container {
                margin: 16px;
                padding: 24px;
                max-height: 85vh;
                border-radius: 20px;
            }
            
            .form-actions {
                flex-direction: column;
                gap: 12px;
            }
            
            .btn {
                width: 100%;
                padding: 14px;
                border-radius: 12px;
                font-size: 1rem;
            }
            
            .episode-item {
                padding: 16px;
                border-radius: 12px;
                margin-bottom: 8px;
            }
            
            .back-btn {
                padding: 12px 20px;
                border-radius: 12px;
                font-size: 0.9rem;
                margin-bottom: 20px;
            }
        }
        
        @media (max-width: 480px) {
            .header-content {
                padding: 0 12px;
                min-height: 56px;
            }
            
            .logo {
                font-size: 1.2rem;
            }
            
            .nav-item {
                padding: 8px 12px;
                font-size: 0.85rem;
            }
            
            .main {
                padding: 12px 8px;
                gap: 12px;
            }
            
            .content-panel {
                padding: 12px;
            }
            
            .panel-header {
                padding: 12px 0;
            }
            
            .panel-title {
                font-size: 1rem;
            }
            
            .panel-action {
                padding: 12px;
                font-size: 0.9rem;
            }
            
            .card-content {
                padding: 12px;
            }
            
            .card-title {
                font-size: 0.9rem;
                line-height: 1.4;
            }
            
            .card-image {
                height: 160px;
            }
            
            .episode-item {
                padding: 12px;
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .episode-title {
                font-size: 0.85rem;
                line-height: 1.3;
            }
            
            .episode-meta {
                font-size: 0.75rem;
            }
            
            .quality-btn {
                padding: 8px 12px;
                font-size: 0.8rem;
            }
            
            .form-container {
                margin: 8px;
                padding: 16px;
                border-radius: 16px;
            }
            
            .form-title {
                font-size: 1.1rem;
            }
            
            .form-input {
                padding: 12px 14px;
                font-size: 0.9rem;
                border-radius: 10px;
            }
            
            .btn {
                padding: 12px;
                font-size: 0.9rem;
            }
            
            .player-controls {
                padding: 12px;
            }
            
            .buffer-info {
                font-size: 0.75rem;
            }
            
            .stat-item {
                padding: 8px;
                font-size: 0.7rem;
            }
            
            video {
                max-height: 45vh;
            }
        }
        
        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            .nav-item {
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .panel-action, .btn {
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .card {
                transition: transform 0.1s ease;
            }
            
            .card:active {
                transform: scale(0.98);
            }
            
            .episode-item {
                min-height: 60px;
            }
            
            .quality-btn {
                min-height: 40px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="#" class="logo">StreamHub</a>
            <div style="display: flex; align-items: center; gap: 24px; color: var(--text-muted); font-size: 0.8rem;">
                <div id="system-info" style="display: flex; gap: 16px;"></div>
            </div>
            <nav class="nav">
                <button class="nav-item active" onclick="showSection('titles')">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</button>
                <button class="nav-item" onclick="showSection('videos')">–í–∏–¥–µ–æ</button>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main" id="main-content">
        <!-- Player Panel -->
        <div class="player-panel">
            <div class="player-header">
                <div class="player-title" id="current-title">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</div>
                <div class="player-status" id="player-status">–ì–æ—Ç–æ–≤</div>
            </div>
            <div class="video-container">
                <video id="video" controls>
                    –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ
                </video>
            </div>
            <div class="player-controls">
                <div class="buffer-info" id="buffer-info" style="display: none;">
                    <span id="buffer-text">–ë—É—Ñ–µ—Ä:</span>
                    <div class="buffer-bar">
                        <div class="buffer-progress" id="buffer-progress"></div>
                    </div>
                    <span id="buffer-percent">0%</span>
                </div>
                <div class="quality-selector" id="quality-selector"></div>
                <div class="stream-stats" id="stream-stats" style="display: none;"></div>
            </div>
        </div>

        <!-- Content Panel -->
        <div class="content-panel">
            <div class="panel-header">
                <div class="panel-title" id="panel-title">–¢–∞–π—Ç–ª—ã</div>
                <button class="panel-action" onclick="showAddForm()">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
            <div class="panel-content" id="panel-content">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </main>

    <!-- Add Form Modal -->
    <div class="form-modal hidden" id="form-modal">
        <div class="form-container">
            <div class="form-header">
                <div class="form-title" id="form-title">–î–æ–±–∞–≤–∏—Ç—å —Ç–∞–π—Ç–ª</div>
            </div>
            <div id="form-content">
                <!-- Form fields will be loaded here -->
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideAddForm()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" id="form-submit">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const currentTitleEl = document.getElementById('current-title');
        const playerStatusEl = document.getElementById('player-status');
        const qualitySelectorEl = document.getElementById('quality-selector');
        const panelTitleEl = document.getElementById('panel-title');
        const panelContentEl = document.getElementById('panel-content');
        const mainContentEl = document.getElementById('main-content');
        const bufferInfoEl = document.getElementById('buffer-info');
        const bufferProgressEl = document.getElementById('buffer-progress');
        const bufferPercentEl = document.getElementById('buffer-percent');
        const streamStatsEl = document.getElementById('stream-stats');
        
        let hls = null;
        let currentSection = 'titles';
        let currentTitleId = null;
        let currentEpisode = null;
        let streamingStats = {
            bytesLoaded: 0,
            totalBytes: 0,
            downloadSpeed: 0,
            bufferHealth: 0
        };

        // Navigation
        function showSection(section) {
            currentSection = section;
            
            // Update nav
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update layout
            if (section === 'titles') {
                mainContentEl.classList.add('layout-2col');
                panelTitleEl.textContent = '–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞';
                loadTitles();
            } else if (section === 'videos') {
                mainContentEl.classList.add('layout-2col');
                panelTitleEl.textContent = '–í–∏–¥–µ–æ';
                loadVideos();
            }
        }

        // Load titles
        async function loadTitles() {
            try {
                const response = await fetch('/titles');
                const titles = await response.json();
                renderTitles(titles);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞–π—Ç–ª–æ–≤:', error);
            }
        }

        function renderTitles(titles) {
            panelContentEl.innerHTML = `
                <div class="cards-grid">
                    ${titles.map(title => `
                        <div class="card" onclick="showEpisodes(${title.id})">
                            <button class="card-delete" onclick="event.stopPropagation(); deleteTitle(${title.id})">√ó</button>
                            <div class="card-image">
                                ${title.poster_url ? `<img src="${title.poster_url}" alt="${title.name}">` : 'üé¨'}
                            </div>
                            <div class="card-content">
                                <div class="card-title">${title.name}</div>
                                <div class="card-meta">${title.year || ''} ${title.genre ? '‚Ä¢ ' + title.genre : ''}</div>
                                <div class="card-description">${title.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Show title details
        async function showEpisodes(titleId) {
            currentTitleId = titleId;
            try {
                const [titleResponse, episodesResponse] = await Promise.all([
                    fetch(`/titles/${titleId}`),
                    fetch(`/episodes/title/${titleId}`)
                ]);
                
                const title = await titleResponse.json();
                const episodes = await episodesResponse.json();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø–∞–Ω–µ–ª–∏
                panelTitleEl.textContent = title.name;
                
                renderTitleDetails(title, episodes);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞–π—Ç–ª–∞:', error);
            }
        }

        // Render title details page
        function renderTitleDetails(title, episodes) {
            const totalEpisodes = episodes.length;
            const seasons = [...new Set(episodes.map(ep => ep.season))].sort();
            const totalDuration = episodes.reduce((sum, ep) => sum + (ep.duration || 0), 0);
            const avgDuration = totalEpisodes > 0 ? Math.round(totalDuration / totalEpisodes / 60) : 0;
            const createdDate = new Date(title.created_at).toLocaleDateString('ru-RU');
            
            let html = `
                <button class="back-btn" onclick="backToTitles()">‚Üê –ù–∞–∑–∞–¥ –∫ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ</button>
                
<div style="
   display: grid;
    grid-template-columns: 200px 1fr;
    gap: 60px;
    margin-bottom: 48px;
    padding: 48px;
    background: var(--bg-tertiary);
    border-radius: 16px;
    width: 100%;
    margin-left: auto;
    margin-right: auto;
">
    <!-- –ü–æ—Å—Ç–µ—Ä -->
    <div style="flex-shrink: 0;">
        <div style="
            width: 200px;
            height: 300px;
            background: linear-gradient(135deg, var(--bg-tertiary), var(--border));
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            color: var(--text-muted);
            overflow: hidden;
        ">
            ${title.poster_url
                ? `<img src="${title.poster_url}" alt="${title.name}" style="width: 100%; height: 100%; object-fit: cover;">`
                : 'üé¨'}
        </div>
    </div>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–∞–π—Ç–ª–µ -->
    <div style="flex: 1; min-width: 0;"> <!-- –ò–∑–º–µ–Ω–µ–Ω–æ min-width –Ω–∞ 0 -->
        <h2 style="
            color: var(--text-primary);
            margin-bottom: 28px;
            font-size: 2.6rem;
            font-weight: 700;
            line-height: 1.2;
        ">
            ${title.name}
        </h2>
        
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        ">
            <div style="background: var(--bg-secondary); padding: 16px 20px; border-radius: 10px; text-align: center;">
                <div style="color: var(--accent); font-size: 1.6rem; font-weight: 700;">${totalEpisodes}</div>
                <div style="color: var(--text-muted); font-size: 0.95rem;">–≠–ø–∏–∑–æ–¥–æ–≤</div>
            </div>
            <div style="background: var(--bg-secondary); padding: 16px 20px; border-radius: 10px; text-align: center;">
                <div style="color: var(--accent); font-size: 1.6rem; font-weight: 700;">${seasons.length}</div>
                <div style="color: var(--text-muted); font-size: 0.95rem;">–°–µ–∑–æ–Ω–æ–≤</div>
            </div>
            ${avgDuration > 0 ? `
                <div style="background: var(--bg-secondary); padding: 16px 20px; border-radius: 10px; text-align: center;">
                    <div style="color: var(--accent); font-size: 1.6rem; font-weight: 700;">${avgDuration}</div>
                    <div style="color: var(--text-muted); font-size: 0.95rem;">–ú–∏–Ω/—ç–ø</div>
                </div>
            ` : ''}
            ${title.year ? `
                <div style="background: var(--bg-secondary); padding: 16px 20px; border-radius: 10px; text-align: center;">
                    <div style="color: var(--accent); font-size: 1.6rem; font-weight: 700;">${title.year}</div>
                    <div style="color: var(--text-muted); font-size: 0.95rem;">–ì–æ–¥</div>
                </div>
            ` : ''}
        </div>

        <!-- –ñ–∞–Ω—Ä –∏ –¥–∞—Ç–∞ -->
        <div style="color: var(--text-muted); font-size: 1.1rem; margin-bottom: 20px;">
            ${title.genre ? `üé® ${title.genre}` : ''}
            ${createdDate ? ` ‚Ä¢ üìÖ –î–æ–±–∞–≤–ª–µ–Ω: ${createdDate}` : ''}
        </div>

        <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
        <p style="
            color: var(--text-secondary);
            font-size: 1rem;
            line-height: 1.8;
            margin-bottom: 36px;
            width: 100%; /* –£–±—Ä–∞–Ω–æ max-width */
        ">
            ${title.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}
        </p>

        <!-- –ö–Ω–æ–ø–∫–∏ -->
        <div style="display: flex; flex-wrap: wrap; gap: 20px;">
            <button onclick="showEpisodesView()" style="
                padding: 18px 36px;
                background: var(--accent);
                color: #ffffff;
                border: none;
                border-radius: 10px;
                cursor: pointer;
                font-weight: 700;
                font-size: 1.2rem;
                transition: transform 0.2s ease, background 0.2s ease;
            " onmouseover="this.style.background='var(--accent-hover)'; this.style.transform='scale(1.03)'"
              onmouseout="this.style.background='var(--accent)'; this.style.transform='scale(1)'">
                ‚ñ∂ –°–º–æ—Ç—Ä–µ—Ç—å —ç–ø–∏–∑–æ–¥—ã
            </button>
            ${totalDuration > 0 ? `
                <div style="
                    padding: 16px 24px;
                    background: var(--bg-secondary);
                    border-radius: 10px;
                    color: var(--text-muted);
                    font-size: 1rem;
                    display: flex;
                    align-items: center;
                    font-weight: 500;
                ">
                    üï∞ –û–±—â–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${Math.floor(totalDuration / 3600)}—á ${Math.floor((totalDuration % 3600) / 60)}–º
                </div>
            ` : ''}
        </div>
    </div>
</div>

            `;
            
            panelContentEl.innerHTML = html;
        }
        
        // Show all episodes view
        function showEpisodesView() {
            if (!currentTitleId) return;
            
            fetch(`/episodes/title/${currentTitleId}`)
                .then(response => response.json())
                .then(episodes => {
                    renderAllEpisodes(episodes);
                })
                .catch(error => console.error('–û—à–∏–±–∫–∞:', error));
        }
        
        // Show specific season episodes
        function showSeasonEpisodes(season) {
            if (!currentTitleId) return;
            
            fetch(`/episodes/title/${currentTitleId}`)
                .then(response => response.json())
                .then(episodes => {
                    const seasonEpisodes = episodes.filter(ep => ep.season === season);
                    renderSeasonEpisodes(season, seasonEpisodes);
                })
                .catch(error => console.error('–û—à–∏–±–∫–∞:', error));
        }
        
        // Render all episodes
        function renderAllEpisodes(episodes) {
            const groupedEpisodes = {};
            episodes.forEach(ep => {
                if (!groupedEpisodes[ep.season]) groupedEpisodes[ep.season] = [];
                groupedEpisodes[ep.season].push(ep);
            });

            let html = `
                <button class="back-btn" onclick="showEpisodes(${currentTitleId})">‚Üê –ù–∞–∑–∞–¥ –∫ —Ç–∞–π—Ç–ª—É</button>
                <h3 style="color: var(--text-primary); margin-bottom: 20px;">–í—Å–µ —ç–ø–∏–∑–æ–¥—ã</h3>
            `;

            Object.keys(groupedEpisodes).sort().forEach(season => {
                html += `
                    <div class="episodes-section">
                        <div class="season-header">–°–µ–∑–æ–Ω ${season}</div>
                        <div class="episodes-grid">
                            ${groupedEpisodes[season].map(episode => `
                                <div class="episode-item" onclick="playEpisode(${episode.id})">
                                    <div class="episode-info">
                                        <div class="episode-title">–≠–ø. ${episode.episode}: ${episode.name}</div>
                                        <div class="episode-meta">
                                            ${episode.duration ? Math.floor(episode.duration / 60) + ' –º–∏–Ω' : ''} 
                                            ${episode.qualities ? '‚Ä¢ ' + episode.qualities.length + ' –∫–∞—á–µ—Å—Ç–≤' : ''}
                                        </div>
                                    </div>
                                    <button class="card-delete" onclick="event.stopPropagation(); deleteEpisode(${episode.id})" style="position: static; opacity: 1; margin-left: 12px;">√ó</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            panelContentEl.innerHTML = html;
        }
        
        // Render season episodes
        function renderSeasonEpisodes(season, episodes) {
            let html = `
                <button class="back-btn" onclick="showEpisodes(${currentTitleId})">‚Üê –ù–∞–∑–∞–¥ –∫ —Ç–∞–π—Ç–ª—É</button>
                <h3 style="color: var(--text-primary); margin-bottom: 20px;">–°–µ–∑–æ–Ω ${season}</h3>
                <div class="episodes-grid">
                    ${episodes.map(episode => `
                        <div class="episode-item" onclick="playEpisode(${episode.id})">
                            <div class="episode-info">
                                <div class="episode-title">–≠–ø. ${episode.episode}: ${episode.name}</div>
                                <div class="episode-meta">
                                    ${episode.duration ? Math.floor(episode.duration / 60) + ' –º–∏–Ω' : ''} 
                                    ${episode.qualities ? '‚Ä¢ ' + episode.qualities.length + ' –∫–∞—á–µ—Å—Ç–≤' : ''}
                                </div>
                            </div>
                            <button class="card-delete" onclick="event.stopPropagation(); deleteEpisode(${episode.id})" style="position: static; opacity: 1; margin-left: 12px;">√ó</button>
                        </div>
                    `).join('')}
                </div>
            `;
            
            panelContentEl.innerHTML = html;
        }

        // Play episode
        async function playEpisode(episodeId) {
            try {
                const response = await fetch(`/episodes/${episodeId}`);
                const episode = await response.json();
                currentEpisode = episode;
                
                currentTitleEl.textContent = `${episode.name} (–°${episode.season}–≠${episode.episode})`;
                
                if (episode.qualities && episode.qualities.length > 0) {
                    renderQualitySelector(episode.qualities);
                    playVideoWithQuality(episode.qualities[0].url, episode.qualities[0].quality);
                } else {
                    playVideo(episode.url, episode.name);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —ç–ø–∏–∑–æ–¥–∞:', error);
            }
        }

        function renderQualitySelector(qualities) {
            qualitySelectorEl.innerHTML = qualities.map(q => 
                `<button class="quality-btn" onclick="switchQuality('${q.url}', '${q.quality}')">${q.quality}</button>`
            ).join('');
            
            if (qualities.length > 0) {
                qualitySelectorEl.querySelector('.quality-btn').classList.add('active');
            }
        }

        function switchQuality(url, quality) {
            document.querySelectorAll('.quality-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            playVideoWithQuality(url, quality);
        }

        function playVideoWithQuality(url, quality) {
            playVideo(url, quality);
        }

        // Streaming monitoring functions
        function updateBufferInfo() {
            if (video.buffered.length > 0 && video.duration) {
                const buffered = video.buffered.end(video.buffered.length - 1);
                const percent = (buffered / video.duration * 100).toFixed(1);
                const currentTime = video.currentTime;
                const bufferAhead = buffered - currentTime;
                
                bufferProgressEl.style.width = percent + '%';
                bufferPercentEl.textContent = percent + '%';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                streamingStats.bufferHealth = bufferAhead;
                updateStreamStats();
                
                bufferInfoEl.style.display = 'flex';
            }
        }
        
        function updateStreamStats() {
            const stats = [
                { label: '–ë—É—Ñ–µ—Ä', value: `${streamingStats.bufferHealth.toFixed(1)}—Å` },
                { label: '–°–∫–æ—Ä–æ—Å—Ç—å', value: formatBytes(streamingStats.downloadSpeed) + '/—Å' },
                { label: '–ó–∞–≥—Ä—É–∂–µ–Ω–æ', value: formatBytes(streamingStats.bytesLoaded) }
            ];
            
            streamStatsEl.innerHTML = stats.map(stat => 
                `<div class="stat-item">
                    <div class="stat-value">${stat.value}</div>
                    <div>${stat.label}</div>
                </div>`
            ).join('');
            
            streamStatsEl.style.display = 'grid';
        }
        
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
        
        function enableStreamingOptimization() {
            // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è HTTP Range Requests
            video.preload = 'metadata'; // –ù–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Å—Ä–∞–∑—É
            
            // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏
            const bufferMonitor = setInterval(() => {
                if (!video.paused && !video.ended) {
                    updateBufferInfo();
                }
            }, 1000);
            
            // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –æ–∫–æ–Ω—á–∞–Ω–∏–∏
            video.addEventListener('ended', () => clearInterval(bufferMonitor), { once: true });
            video.addEventListener('pause', () => clearInterval(bufferMonitor), { once: true });
            
            return bufferMonitor;
        }
        
        // Main play function
        async function playVideo(url, info) {
            if (hls) {
                hls.destroy();
                hls = null;
            }

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            streamingStats = { bytesLoaded: 0, totalBytes: 0, downloadSpeed: 0, bufferHealth: 0 };
            bufferInfoEl.style.display = 'none';
            streamStatsEl.style.display = 'none';

            playerStatusEl.textContent = 'üîÑ –ó–∞–≥—Ä—É–∑–∫–∞...';

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º URL
            const processedUrl = await processVideoUrl(url);

            if (url.includes('.m3u8')) {
                if (Hls.isSupported()) {
                    hls = new Hls({
                        maxBufferLength: 30,
                        maxMaxBufferLength: 60,
                        enableWorker: true,
                        lowLatencyMode: true,
                        backBufferLength: 90
                    });
                    
                    hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        playerStatusEl.textContent = 'üì∫ HLS ‚Ä¢ –ú–∞–Ω–∏—Ñ–µ—Å—Ç –∑–∞–≥—Ä—É–∂–µ–Ω';
                    });
                    
                    hls.on(Hls.Events.LEVEL_SWITCHED, (event, data) => {
                        const level = hls.levels[data.level];
                        const quality = level ? `${level.height}p (${Math.round(level.bitrate/1000)}kbps)` : 'Auto';
                        playerStatusEl.textContent = `üì∫ HLS ‚Ä¢ ${quality}`;
                    });
                    
                    hls.on(Hls.Events.ERROR, (event, data) => {
                        console.error('HLS –æ—à–∏–±–∫–∞:', data);
                        playerStatusEl.textContent = '‚ùå –û—à–∏–±–∫–∞ HLS';
                    });
                    
                    hls.loadSource(processedUrl);
                    hls.attachMedia(video);
                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    video.src = processedUrl;
                    playerStatusEl.textContent = 'üçé Safari HLS';
                }
            } else {
                // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å—Ç—Ä–∏–º–∏–Ω–≥–æ–≤–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
                enableStreamingOptimization();
                video.playsInline = true;
                video.removeAttribute('crossOrigin');
                video.src = processedUrl;
                
                let format = 'VIDEO';
                if (url.toLowerCase().includes('.mp4')) format = 'MP4';
                else if (url.toLowerCase().includes('.webm')) format = 'WEBM';
                else if (url.toLowerCase().includes('.avi')) format = 'AVI';
                
                playerStatusEl.textContent = `üé• ${format} ‚Ä¢ ${info} ‚Ä¢ üì° –°—Ç—Ä–∏–º–∏–Ω–≥`;
                
                // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∫–æ—Ä–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∑–∫–∏
                let lastLoaded = 0;
                let lastTime = Date.now();
                
                const speedMonitor = setInterval(() => {
                    if (video.buffered.length > 0) {
                        const currentLoaded = video.buffered.end(video.buffered.length - 1) * 1000000; // –ü—Ä–∏–º–µ—Ä–Ω—ã–µ –±–∞–π—Ç—ã
                        const currentTime = Date.now();
                        const timeDiff = (currentTime - lastTime) / 1000;
                        const bytesDiff = currentLoaded - lastLoaded;
                        
                        if (timeDiff > 0) {
                            streamingStats.downloadSpeed = bytesDiff / timeDiff;
                            streamingStats.bytesLoaded = currentLoaded;
                        }
                        
                        lastLoaded = currentLoaded;
                        lastTime = currentTime;
                    }
                }, 2000);
                
                video.addEventListener('ended', () => clearInterval(speedMonitor), { once: true });
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            video.addEventListener('loadstart', () => {
                playerStatusEl.textContent = playerStatusEl.textContent.replace('üîÑ', 'üîÑ');
            }, { once: true });
            
            video.addEventListener('canplay', () => {
                playerStatusEl.textContent = playerStatusEl.textContent.replace('üîÑ', '‚úÖ');
            }, { once: true });
            
            video.addEventListener('playing', () => {
                playerStatusEl.textContent = playerStatusEl.textContent.replace(/[üîÑ‚úÖ]/, '‚ñ∂Ô∏è');
            });
            
            video.addEventListener('pause', () => {
                playerStatusEl.textContent = playerStatusEl.textContent.replace('‚ñ∂Ô∏è', '‚è∏Ô∏è');
            });
            
            video.addEventListener('error', (e) => {
                console.error('–û—à–∏–±–∫–∞ –≤–∏–¥–µ–æ:', e);
                const errorCode = video.error ? video.error.code : 'Unknown';
                playerStatusEl.innerHTML = `‚ùå –û—à–∏–±–∫–∞ ${errorCode} ‚Ä¢ <button onclick="forcePlay()" style="background: var(--accent); color: #ffffff; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>`;
            });
            
            video.addEventListener('loadedmetadata', () => {
                if (video.videoWidth && video.videoHeight) {
                    const resolution = `${video.videoWidth}x${video.videoHeight}`;
                    playerStatusEl.textContent += ` ‚Ä¢ ${resolution}`;
                }
            }, { once: true });
            
            setTimeout(() => {
                video.play().catch(e => {
                    console.log('–ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω:', e.message);
                    playerStatusEl.innerHTML = playerStatusEl.textContent.replace(/[üîÑ‚úÖ]/, '‚èØÔ∏è') + ` ‚Ä¢ <button onclick="forcePlay()" style="background: var(--accent); color: #ffffff; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å</button>`;
                });
            }, 100);
        }
        
        // Force play function
        function forcePlay() {
            if (video.src) {
                playerStatusEl.textContent = 'üîÑ –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—É—Å–∫–∞...';
                
                video.load();
                
                setTimeout(() => {
                    video.play()
                        .then(() => {
                            playerStatusEl.textContent = '‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ';
                        })
                        .catch(e => {
                            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞:', e);
                            
                            video.crossOrigin = null;
                            video.load();
                            
                            setTimeout(() => {
                                video.play().catch(err => {
                                    playerStatusEl.innerHTML = `‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å ‚Ä¢ <button onclick="openVideoInNewTab()" style="background: var(--accent); color: #ffffff; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">–û—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ</button>`;
                                });
                            }, 500);
                        });
                }, 500);
            }
        }
        
        // Open video in new tab
        function openVideoInNewTab() {
            if (video.src) {
                window.open(video.src, '_blank');
            }
        }
        
        // Add click handler to video for manual play
        video.addEventListener('click', () => {
            // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–∏–¥–µ–æ –≤ –æ—à–∏–±–∫–µ –∏–ª–∏ –Ω–∞ –ø–∞—É–∑–µ
            if (video.error || video.paused) {
                if (video.error) {
                    forcePlay();
                } else {
                    video.play();
                }
            } else {
                video.pause();
            }
        });

        // Load videos (legacy)
        async function loadVideos() {
            try {
                const response = await fetch('/videos');
                const videos = await response.json();
                renderVideos(videos);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ:', error);
            }
        }

        function renderVideos(videos) {
            panelContentEl.innerHTML = `
                <div class="cards-grid">
                    ${videos.map(v => `
                        <div class="card" onclick="playVideo('${v.url}', '${v.title}')">
                            <button class="card-delete" onclick="event.stopPropagation(); deleteVideo(${v.id})">√ó</button>
                            <div class="card-image">üé•</div>
                            <div class="card-content">
                                <div class="card-title">${v.title}</div>
                                <div class="card-meta">${v.duration ? Math.floor(v.duration / 60) + ' –º–∏–Ω' : ''}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Forms
        function showAddForm() {
            const modal = document.getElementById('form-modal');
            const formTitle = document.getElementById('form-title');
            const formContent = document.getElementById('form-content');
            const submitBtn = document.getElementById('form-submit');
            
            if (currentTitleId) {
                // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ç–∞–π—Ç–ª - –¥–æ–±–∞–≤–ª—è–µ–º —ç–ø–∏–∑–æ–¥ –∫ –Ω–µ–º—É
                formTitle.textContent = '–î–æ–±–∞–≤–∏—Ç—å —ç–ø–∏–∑–æ–¥';
                formContent.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —ç–ø–∏–∑–æ–¥–∞</label>
                        <input type="text" id="episode-name" class="form-input" placeholder="–ü–∞–¥–µ–Ω–∏–µ –®–∏–≥–∞–Ω—à–∏–Ω—ã">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–°–µ–∑–æ–Ω</label>
                        <input type="number" id="episode-season" class="form-input" placeholder="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–≠–ø–∏–∑–æ–¥</label>
                        <input type="number" id="episode-number" class="form-input" placeholder="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ö–∞—á–µ—Å—Ç–≤–∞ –≤–∏–¥–µ–æ (JSON)</label>
                        <textarea id="episode-qualities" class="form-input form-textarea" placeholder='[{"quality":"720p","url":"https://example.com/video720.mp4"}]'></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ü—Ä–µ–≤—å—é URL</label>
                        <input type="url" id="episode-thumbnail" class="form-input" placeholder="https://example.com/thumb.jpg">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (—Å–µ–∫)</label>
                        <input type="number" id="episode-duration" class="form-input" placeholder="1440">
                    </div>
                `;
                submitBtn.onclick = addEpisode;
            } else if (currentSection === 'titles') {
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Ç–∞–π—Ç–ª
                formTitle.textContent = '–î–æ–±–∞–≤–∏—Ç—å —Ç–∞–π—Ç–ª';
                formContent.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                        <input type="text" id="title-name" class="form-input" placeholder="–ê—Ç–∞–∫–∞ —Ç–∏—Ç–∞–Ω–æ–≤">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea id="title-description" class="form-input form-textarea" placeholder="–≠–ø–∏—á–µ—Å–∫–æ–µ –∞–Ω–∏–º–µ –ø—Ä–æ —Ç–∏—Ç–∞–Ω–æ–≤"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ü–æ—Å—Ç–µ—Ä URL</label>
                        <input type="url" id="title-poster" class="form-input" placeholder="https://example.com/poster.jpg">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ñ–∞–Ω—Ä</label>
                        <input type="text" id="title-genre" class="form-input" placeholder="–ê–Ω–∏–º–µ, –≠–∫—à–Ω">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ì–æ–¥</label>
                        <input type="number" id="title-year" class="form-input" placeholder="2013">
                    </div>
                `;
                submitBtn.onclick = addTitle;
            } else if (currentSection === 'videos') {
                // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ
                formTitle.textContent = '–î–æ–±–∞–≤–∏—Ç—å –≤–∏–¥–µ–æ';
                formContent.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                        <input type="text" id="video-title" class="form-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ">
                    </div>
                    <div class="form-group">
                        <label class="form-label">URL –≤–∏–¥–µ–æ</label>
                        <input type="url" id="video-url" class="form-input" placeholder="https://example.com/video.mp4">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ü—Ä–µ–≤—å—é URL</label>
                        <input type="url" id="video-thumbnail" class="form-input" placeholder="https://example.com/thumb.jpg">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (—Å–µ–∫)</label>
                        <input type="number" id="video-duration" class="form-input" placeholder="3600">
                    </div>
                `;
                submitBtn.onclick = addVideo;
            }
            
            modal.classList.remove('hidden');
        }

        function hideAddForm() {
            document.getElementById('form-modal').classList.add('hidden');
        }

        // CRUD operations
        async function addTitle() {
            const name = document.getElementById('title-name').value;
            const description = document.getElementById('title-description').value;
            const poster_url = document.getElementById('title-poster').value;
            const genre = document.getElementById('title-genre').value;
            const year = document.getElementById('title-year').value;

            if (!name) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–∞–π—Ç–ª–∞');
                return;
            }

            try {
                const response = await fetch('/titles', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer video-player-token-2024'
                    },
                    body: JSON.stringify({
                        name,
                        description: description || null,
                        poster_url: poster_url || null,
                        genre: genre || null,
                        year: year ? parseInt(year) : null
                    })
                });

                if (response.ok) {
                    hideAddForm();
                    loadTitles();
                } else {
                    alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–∞–π—Ç–ª–∞');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–∞–π—Ç–ª–∞');
            }
        }

        async function addEpisode() {
            const name = document.getElementById('episode-name').value;
            const season = document.getElementById('episode-season').value;
            const episode = document.getElementById('episode-number').value;
            const qualitiesText = document.getElementById('episode-qualities').value;
            const thumbnail_url = document.getElementById('episode-thumbnail').value;
            const duration = document.getElementById('episode-duration').value;

            if (!name || !season || !episode || !qualitiesText) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
                return;
            }

            try {
                const qualities = JSON.parse(qualitiesText);
                
                const response = await fetch('/episodes', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer video-player-token-2024'
                    },
                    body: JSON.stringify({
                        title_id: currentTitleId,
                        season: parseInt(season),
                        episode: parseInt(episode),
                        name,
                        qualities,
                        thumbnail_url: thumbnail_url || null,
                        duration: duration ? parseInt(duration) : null
                    })
                });

                if (response.ok) {
                    hideAddForm();
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ç–∞–π—Ç–ª–∞ —Å –Ω–æ–≤—ã–º —ç–ø–∏–∑–æ–¥–æ–º
                    showEpisodes(currentTitleId);
                } else {
                    alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —ç–ø–∏–∑–æ–¥–∞');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON –∫–∞—á–µ—Å—Ç–≤');
            }
        }

        async function addVideo() {
            const title = document.getElementById('video-title').value;
            const url = document.getElementById('video-url').value;
            const thumbnail = document.getElementById('video-thumbnail').value;
            const duration = document.getElementById('video-duration').value;

            if (!title || !url) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ URL');
                return;
            }

            try {
                const response = await fetch('/videos', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer video-player-token-2024'
                    },
                    body: JSON.stringify({
                        title,
                        url,
                        thumbnail_url: thumbnail || null,
                        duration: duration ? parseInt(duration) : null
                    })
                });

                if (response.ok) {
                    hideAddForm();
                    loadVideos();
                } else {
                    alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤–∏–¥–µ–æ');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤–∏–¥–µ–æ');
            }
        }

        // Delete functions
        async function deleteTitle(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–∞–π—Ç–ª –∏ –≤—Å–µ –µ–≥–æ —ç–ø–∏–∑–æ–¥—ã?')) return;
            try {
                const response = await fetch(`/titles/${id}`, { 
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer video-player-token-2024' }
                });
                if (response.ok) loadTitles();
                else alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
            }
        }

        async function deleteEpisode(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç–ø–∏–∑–æ–¥?')) return;
            try {
                const response = await fetch(`/episodes/${id}`, { 
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer video-player-token-2024' }
                });
                if (response.ok) showEpisodes(currentTitleId);
                else alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
            }
        }

        async function deleteVideo(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤–∏–¥–µ–æ?')) return;
            try {
                const response = await fetch(`/videos/${id}`, { 
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer video-player-token-2024' }
                });
                if (response.ok) loadVideos();
                else alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
            }
        }

        // –í–æ–∑–≤—Ä–∞—Ç –∫ —Å–ø–∏—Å–∫—É —Ç–∞–π—Ç–ª–æ–≤
        function backToTitles() {
            currentTitleId = null;
            panelTitleEl.textContent = '–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞';
            loadTitles();
        }

        // System info
        function updateSystemInfo() {
            const systemInfoEl = document.getElementById('system-info');
            const now = new Date();
            const uptime = Math.floor((now - new Date(sessionStorage.getItem('startTime') || now)) / 1000);
            const uptimeStr = uptime > 3600 ? `${Math.floor(uptime/3600)}—á ${Math.floor((uptime%3600)/60)}–º` : `${Math.floor(uptime/60)}–º ${uptime%60}—Å`;
            
            systemInfoEl.innerHTML = `
                <span>üï∞ ${now.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}</span>
                <span>‚ö° –ê–ø—Ç–∞–π–º: ${uptimeStr}</span>
                <span id="connection-status">üü¢ –û–Ω–ª–∞–π–Ω</span>
            `;
        }
        
        // Connection status
        function checkConnection() {
            const statusEl = document.getElementById('connection-status');
            if (navigator.onLine) {
                statusEl.innerHTML = 'üü¢ –û–Ω–ª–∞–π–Ω';
                statusEl.style.color = 'var(--accent)';
            } else {
                statusEl.innerHTML = 'üî¥ –û—Ñ–ª–∞–π–Ω';
                statusEl.style.color = '#ff6b6b';
            }
        }
        
        // Advanced streaming support
        async function checkStreamingSupport(url) {
            try {
                const response = await fetch(url, { 
                    method: 'HEAD',
                    headers: { 'Range': 'bytes=0-1' }
                });
                
                const supportsRanges = response.headers.get('Accept-Ranges') === 'bytes';
                const contentLength = response.headers.get('Content-Length');
                
                if (supportsRanges) {
                    console.log('‚úÖ –°–µ—Ä–≤–µ—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç HTTP Range –∑–∞–ø—Ä–æ—Å—ã - —Å—Ç—Ä–∏–º–∏–Ω–≥ –≤–∫–ª—é—á–µ–Ω');
                    streamingStats.totalBytes = parseInt(contentLength) || 0;
                    return { supportsRanges: true, totalSize: streamingStats.totalBytes };
                } else {
                    console.log('‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Range –∑–∞–ø—Ä–æ—Å—ã - –ø–æ–ª–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞');
                    return { supportsRanges: false, totalSize: 0 };
                }
            } catch (error) {
                console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É Range –∑–∞–ø—Ä–æ—Å–æ–≤:', error);
                return { supportsRanges: false, totalSize: 0 };
            }
        }
        
        // Smart seeking with range requests
        function enableSmartSeeking() {
            let lastSeekTime = 0;
            
            video.addEventListener('seeking', () => {
                const currentTime = Date.now();
                if (currentTime - lastSeekTime > 1000) {
                    console.log(`üîç –ü–µ—Ä–µ–º–æ—Ç–∫–∞ –Ω–∞ ${video.currentTime.toFixed(1)}—Å - –∑–∞–≥—Ä—É–∑–∫–∞ –Ω—É–∂–Ω–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞`);
                    playerStatusEl.textContent = playerStatusEl.textContent.replace(/[‚ñ∂Ô∏è‚è∏Ô∏è]/, 'üîç') + ' ‚Ä¢ –ü–µ—Ä–µ–º–æ—Ç–∫–∞';
                    lastSeekTime = currentTime;
                }
            });
            
            video.addEventListener('seeked', () => {
                console.log('‚úÖ –ü–µ—Ä–µ–º–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ - —Å–µ–≥–º–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–µ–Ω');
                playerStatusEl.textContent = playerStatusEl.textContent.replace('üîç', '‚ñ∂Ô∏è').replace(' ‚Ä¢ –ü–µ—Ä–µ–º–æ—Ç–∫–∞', '');
                updateBufferInfo();
            });
        }
        
        // Video URL validation and processing
        async function processVideoUrl(url) {
            const videoExtensions = ['.mp4', '.webm', '.avi', '.mov', '.m3u8'];
            const isDirectVideo = videoExtensions.some(ext => url.toLowerCase().includes(ext));
            
            if (isDirectVideo) {
                try {
                    const streamInfo = await checkStreamingSupport(url);
                    if (streamInfo.supportsRanges) {
                        setTimeout(() => {
                            playerStatusEl.textContent += ' ‚Ä¢ üì° Range';
                            enableSmartSeeking();
                        }, 100);
                    }
                } catch (error) {
                    console.log('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ Range:', error);
                }
            } else if (!url.includes('blob:') && !url.includes('data:')) {
                console.warn('–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: URL –º–æ–∂–µ—Ç –Ω–µ –±—ã—Ç—å –ø—Ä—è–º–æ–π —Å—Å—ã–ª–∫–æ–π –Ω–∞ –≤–∏–¥–µ–æ:', url);
                
                if (url.includes('save.php') || url.includes('download')) {
                    console.log('–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —Å—Å—ã–ª–∫–∞ –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ - –ø–æ–ø—ã—Ç–∫–∞ –ø—Ä—è–º–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è');
                }
            }
            
            return url;
        }
        
        // Initialize
        if (!sessionStorage.getItem('startTime')) {
            sessionStorage.setItem('startTime', new Date().toISOString());
        }
        
        updateSystemInfo();
        setInterval(updateSystemInfo, 30000); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫
        
        window.addEventListener('online', checkConnection);
        window.addEventListener('offline', checkConnection);
        
        loadTitles();
    </script>
</body>
</html>